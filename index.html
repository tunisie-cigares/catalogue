import time
from selenium import webdriver
from bs4 import BeautifulSoup
from urllib.parse import urljoin
import webbrowser

url = "https://www.denner.ch/fr/assortiment/cigares/"

# Set up Chrome WebDriver (Make sure you have the Chrome WebDriver executable installed and in your PATH)
driver = webdriver.Chrome()

# Load the page with Selenium
driver.get(url)

# Scroll to the bottom of the page to trigger dynamic content loading
driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
time.sleep(3)  # Wait for the content to load (adjust the sleep duration if needed)

# Get the page source after the content has loaded
page_source = driver.page_source

# Quit the WebDriver
driver.quit()

# Parse the HTML content using BeautifulSoup
soup = BeautifulSoup(page_source, "html.parser")

# Find the elements that contain the catalog data
cigars = soup.find_all("div", class_="col-lg-3 col-sm-4 mb-3")

# Create an HTML string for the matrix layout
html = """
<html>
<head>
<style>
table {
  table-layout: fixed;
  width: 100%;
}

td {
  width: 25%;
  text-align: center;
  padding: 10px;
}

img {
  max-width: 100%;
  height: auto;
}
</style>
</head>
<body>
<table>
"""

html += "<tr>"

#sort cigars by price (keep only numerals and dots
cigars.sort(key=lambda x: float(''.join(filter(lambda y: y.isdigit() or y == '.', x.find("span", class_="aktuell").text.strip().split(" ")[0]))), reverse=False)

# Loop through the elements to get the data
for i, cigar in enumerate(cigars):
    # Find the desired information on the cigar
    cigar_photo_relative = cigar.find("img")["data-src"]
    cigar_photo_absolute = urljoin(url, cigar_photo_relative)
    
    #find the url of the page displayed when you click on the cigar
    cigar_url_relative = cigar.find("a")["href"]
    cigar_url_absolute = urljoin(url, cigar_url_relative)

    driver = webdriver.Chrome()
    driver.get(cigar_url_absolute)
    page_source = driver.page_source
    driver.quit()
    soup = BeautifulSoup(page_source, "html.parser")
    cigar_text = soup.find("div", class_="col-md-6").text.strip()
    #detect the word "pièces" and get the number of pieces before it
    nb_pieces = int(cigar_text.split("pièces")[0].split(" ")[-1])
    cigar_price_element = cigar.find("span", class_="aktuell")
    cigar_price = cigar_price_element.text.strip().split(" ")[0]
    cigar_price = float(''.join(filter(lambda x: x.isdigit() or x == '.', cigar_price)))

    if cigar_price/nb_pieces < 7.5:
        cigar_price = str(int(cigar_price * 2.4 * 3.4)+1)
    elif cigar_price/nb_pieces < 10:
        cigar_price = str(int(cigar_price * 2 * 3.4)+1)
    else:
        cigar_price = str(int(cigar_price * 1.4 * 3.4)+1)

    #take two first digits of the price 
    if int(cigar_price[-2:]) < 10:
        cigar_price = cigar_price[:-3] + str(int(cigar_price[-3])-1) + "99"
    else:
        cigar_price = cigar_price[:-1] + "9"

    cigar_price = cigar_price + " TND"
    cigar_name = cigar.find("h4").text.strip()
    if "Griffin" in cigar_name:
        cigar_name = "Davidoff " + cigar_name

    # Create an HTML string for the cigar
    html += f"""
        <td>
            <img src="{cigar_photo_absolute}">
            <p>{cigar_price}</p>
            <p>{cigar_name}</p>
            <p>{nb_pieces} Pièces</p>
        </td>
    """
    
    # Insert a line break after every 4th cigar
    if (i + 1) % 4 == 0:
        html += "</tr><tr>"

html += "</tr>"
html += "</table></body></html>"

# Save the HTML string to a file
with open("cigars.html", "w") as f:
    f.write(html)

# Open the file in the default browser
webbrowser.open("cigars.html")
